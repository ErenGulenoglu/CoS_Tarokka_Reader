let common_card_name = [
	"Wizard",
	"Transmuter",
	"Diviner",
	"Enchanter",
	"Abjurer",
	"Elementalist",
	"Evoker",
	"Illusionist",
	"Necromancer",
	"Conjurer",
	"Warrior",
	"Avenger",
	"Paladin",
	"Soldier",
	"Mercenary",
	"Myrmidon",
	"Berserker",
	"Hooded One",
	"Dictator",
	"Torturer",
	"Rogue",
	"Swashbuckler",
	"Philanthropist",
	"Trader",
	"Merchant",
	"Guild Member",
	"Beggar",
	"Thief",
	"Tax Collector",
	"Miser",
	"Priest",
	"Monk",
	"Missionary",
	"Healer",
	"Sheperd",
	"Druid",
	"Anarchisht",
	"Charlatan",
	"Bishop",
	"Traitor",
];

common_card_info = [
	"The treasure lies on the top floor of Van Richten's Tower (chapter 11, area V7).",
	"The treasure lies in Castle Ravenloft's north tower peak (chapter 4, area K60).",
	"The treasure lies in Madam Eva's encampment (chapter 2, area G). If she is the one performing the card reading, she says, 'I think the treasure is under my very nose!'",
	"The treasure lies under Marina's monument in Berez (chapter 10, area U5). 'The master of the marsh' refers to Burgomaster Lazlo Ulrich (area U2), whose ghost can point characters toward the monument.",
	"The treasure lies in the beacon of Argynvostholt (chapter 7, area Q53). 'Great stone dragon' refers to the statue in area Q1.",
	"The treasure is inside a model of Castle Ravenloft in the Amber Temple (chapter 13, area X20).",
	"The treasure is hidden in the crypt of Gralmore Nimblenobs (chapter 4, area K84, crypt 37).",
	"The treasure lies in Rictavio's carnival wagon (chapter 5, area N5).",
	"The treasure lies in Castle Ravenloft's study (chapter 4, area K37).",
	"The treasure is in Baba Lysaga's hut (chapter 10, area U3).",
	"The treasure lies in Strahd's tomb (chapter 4, area K86).",
	"The treasure is in the possession of Vladimir Horngaard in Argynvostholt (chapter 7, area Q36).",
	"The treasure lies in Sergei's tomb (chapter 4, area K85).",
	"The treasure lies on the rooftop of the Tsolenka Pass guard tower (chapter 9, area T6).",
	"The treasure lies in a crypt in Castle Ravenloft (chapter 4, area K84, crypt 31).",
	"The treasure lies in the shrine of Mother Night in the werewolf den (chapter 15, area Z7).",
	"The treasure lies in the crypt of General Kroval 'Mad Dog' Grislek (chapter 4, area K84, crypt 38).",
	"The treasure is inside the head of the giant statue in the Amber Temple (chapter 13, area X5a).",
	"The treasure lies in Castle Ravenloft's audience hall (chapter 4, area K25).",
	"The treasure is hidden in the attic of the Burgomaster's mansion in Vallaki (chapter 5, area N3s).",
	"The treasure is hidden in the attic of the Blue Water Inn (chapter 5, area N2q).",
	"The treasure lies in the crypt of Endorovich (chapter 4, area K84, crypt 7).",
	"The treasure is in the nursery of the Abbey of Saint Markovia (chapter 8, area S23).",
	"The treasure lies in the glassblower's workshop in the Wizard of Wines winery (chapter 12, area W10).",
	"The treasure lies in Castle Ravenloft's wine cellar (chapter 4, area K63).",
	"The treasure lies in the crypt of Artank Swilovich (chapter 4, area K84, crypt 5).",
	"The treasure is hidden in Kasimir's hovel (chapter 5, area N9a).",
	"The treasure is buried in the graveyard at the River Ivlis crossroads (chapter 2, area F).",
	"The treasure is hidden in the Vistani treasure wagon (chapter 5, area N9i). 'A missing child' refers to Arabelle (see chapter 2, area L).",
	"The treasure lies in Castle Ravenloft's treasury (chapter 4, area K41).",
	"The treasure lies in Castle Ravenloft's chapel (chapter 4, area K15).",
	"The treasure lies in the main hall of the Abbey of Saint Markovia (chapter 8, area S13).",
	"The treasure is hidden inside one of the scarecrows in the garden of the Abbey of Saint Markovia (chapter 8, area S9).",
	"The treasure lies beneath the gazebo in the Shrine of the White Sun (chapter 8, area S4).",
	"The treasure lies in the tomb of King Barov and Queen Ravenovia (chapter 4, area K88).",
	"The treasure lies at the base of the Gulthias tree (chapter 14, area Y4). Any wereraven encountered in the wilderness can lead the characters to the location.",
	"The treasure lies in Castle Ravenloft's hall of bones (chapter 4, area K67).",
	"The treasure lies in the attic of Old Bonegrinder (chapter 6, area O4).",
	"The treasure lies in the sealed treasury of the Amber Temple (chapter 13, area X40).",
	"The treasure is hidden in the master bedroom of Wachterhaus (chapter 5, area N4o).",
];

let high_card_name = ["Ghost", "Tempter", "Seer", "Raven", "Donjon", "Mists", "Darklord", "Marionette", "Broken One", "Innocent", "Beast", "Horseman", "Artifact", "Executioner"];

let common_cards = [
	"card1",
	"card2",
	"card3",
	"card4",
	"card5",
	"card6",
	"card7",
	"card8",
	"card9",
	"card10",
	"card11",
	"card12",
	"card13",
	"card14",
	"card15",
	"card16",
	"card17",
	"card18",
	"card19",
	"card20",
	"card21",
	"card22",
	"card23",
	"card24",
	"card25",
	"card26",
	"card27",
	"card28",
	"card29",
	"card30",
	"card31",
	"card32",
	"card33",
	"card34",
	"card35",
	"card36",
	"card37",
	"card38",
	"card39",
	"card40",
];

let high_cards = ["card1", "card2", "card3", "card4", "card5", "card6", "card7", "card8", "card9", "card10", "card11", "card12", "card13", "card14"];

common_explanations = [
	"Look for a wizard's tower on a lake. Let the wizard's name and servant guide you to that which you seek.",
	"Go to a place of dizzying heights, where the stone itself is alive!",
	"Look to the one who sees all. The treasure is hidden in her camp.",
	"I see a kneeling woman—a rose of great beauty plucked too soon. The master of the marsh knows of whom I speak.",
	"I see a fallen house guarded by a great stone dragon. Look to the highest peak.",
	"The treasure is hidden in a small castle beneath a mountain, guarded by amber giants.",
	"Search for the crypt of a wizard ordinaire. His staff is the key.",
	"A man is not what he seems. He comes here in a carnival wagon. Therein lies what you seek.",
	"A woman hangs above a roaring fire. Find her, and you will find the treasure.",
	"I see a dead village, drowned by a river, ruled by one who has brought great evil into the world.",
	"That which you seek lies in the womb of darkness, the devil's lair: the one place to which he must return.",
	"The treasure lies in a dragon's house, in hands once clean and now corrupted.",
	"I see a sleeping prince, a servant of light and the brother of darkness. The treasure lies with him.",
	"Go to the mountains. Climb the white tower guarded by golden knights.",
	"The thing you seek lies with the dead, under mountains of gold coins.",
	"Look for a den of wolves in the hills overlooking a mountain lake. The treasure belongs to Mother Night.",
	"Find the Mad Dog's crypt. The treasure lies within, beneath blackened bones.",
	"I see a faceless god. He awaits you at the end of a long and winding road, deep in the mountains.",
	"I see a throne fit for a king.",
	"There is a town where all is not well. There you will find a house of corruption, and within, a dark room full of still ghosts.",
	"I see a nest of ravens. There you will find the prize.",
	"I see the skeleton of a deadly warrior, lying on a bed of stone flanked by gargoyles.",
	"Look to a place where sickness and madness are bred. Where children once cried, the treasure lies still.",
	"Look to the wizard of wines! In wood and sand the treasure hides.",
	"Seek a cask that once contained the finest wine, of which not a drop remains.",
	"I see a dark room full of bottles. It is the tomb of a guild member.",
	"A wounded elf has what you seek. He will part with the treasure to see his dark dreams fulfilled.",
	"What you seek lies at the crossroads of life and death, among the buried dead.",
	"The Vistani have what you seek. A missing child holds the key to the treasure's release.",
	"Look for a fortress inside a fortress, in a place hidden behind fire.",
	"You will find what you seek in the castle, amid the ruins of a place of supplication.",
	"The treasure you seek is hidden behind the sun, in the house of a saint.",
	"I see a garden dusted with snow, watched over by a scarecrow with a sackcloth grin. Look not to the garden but to the guardian.",
	"Look to the west. Find a pool blessed by the light of the white sun.",
	"Find the mother—she who gave birth to evil.",
	"An evil tree grows atop a hill of graves where the ancient dead sleep. The ravens can help you find it. Look for the treasure there.",
	"I see walls of bones, a chandelier of bones, and a table of bones—all that remains of enemies long forgotten.",
	"I see a lonely mill on a precipice. The treasure lies within.",
	"What you seek lies in a pile of treasure, beyond a set of amber doors.",
	"Look for a wealthy woman. A staunch ally of the devil, she keeps the treasure under lock and key, with the bones of an ancient enemy.",
];

strahd_enemy = [
	//needs to be better with dual random choices
	["I see a fallen paladin of a fallen order of knights. He lingers like a ghost in a dead dragon's lair.", "Stir the spirit of the clumsy knight whose crypt lies deep within the castle."],
	[
		"I see a child—a Vistana. You must hurry, for her fate hangs in the balance. Find her at the lake!",
		"I hear a wedding bell, or perhaps a death knell. It calls thee to a mountainside abbey, wherein you will find a woman who is more than the sum of her parts.",
	],
	"Look for a dusk elf living among the Vistani. He has suffered a great loss and is haunted by dark dreams. Help him, and he will help you in return.",
	"Find the leader of the feathered ones who live among the vines. Though old, he has one more fight left in him.",
	[
		"Search for a troubled young man surrounded by wealth and madness. His home is his prison.",
		"Find a girl driven to insanity, locked in the heart of her dead father's house. Curing her madness is key to your success.",
	],
	"A Vistana wanders this land alone, searching for her mentor. She does not stay in one place for long. Seek her out at Saint Markovia's abbey, near the mists.",
	"Ah, the worst of all truths: You must face the evil of this land alone!",
	[
		"What horror is this? I see a man made by a man. Ageless and alone, it haunts the towers of the castle.",
		"Look for a man of music, a man with two heads. He lives in a place of great hunger and sorrow.",
	],
	["Your greatest ally will be a wizard. His mind is broken, but his spells are strong.", "I see a man of faith whose sanity hangs by a thread. He has lost someone close to him."],
	["I see a young man with a kind heart. A mother's boy! He is strong in body but weak of mind. Seek him out in the village of Barovia.", "Evil's bride is the one you seek!"],
	"A werewolf holds a secret hatred for your enemy. Use her hatred to your advantage.",
	[
		"I see a dead man of noble birth, guarded by his widow. Return life to the dead man's corpse, and he will be your staunch ally.",
		"A man of death named Arrigal will forsake his dark lord to serve your cause. Beware! He has a rotten soul.",
	],
	"Look for an entertaining man with a monkey. This man is more than he seems.",
	"Seek out the brother of the devil's bride. They call him 'the lesser,' but he has a powerful soul.",
];

strahd_enemy_info = [
	[
		"This card refers to the revenant Sir Godfrey Gwilym (see chapter 7, area Q37). Although initially unwilling to accompany the characters, he will do so if the characters convince him that the honor of the Order of the Silver Dragon can be restored with his help. Doing this requires a successful DC 15 Charisma (Persuasion) check.",
		"This card refers to Sir Klutz the phantom warrior (see chapter 4, area K84, crypt 33). If Sir Klutz is Strahd's enemy, then the phantom warrior disappears not after seven days, but only after he or Strahd is reduced to 0 hit points.",
	],
	[
		"This card refers to Arabelle (see chapter 2, area L). She gladly joins the party. But if she returns to her camp (chapter 5, area N9), her father, Luvash, refuses to let her leave.",
		"This card refers to Vasilka the flesh golem (see chapter 8, area S13).",
	],
	"This card refers to Kasimir Velikov (see chapter 5, area N9a). The dusk elf accompanies the characters to Castle Ravenloft only after they lead him to the Amber Temple and help him find the means to resurrect his dead sister, Patrina Velikovna.",
	`This card refers to Davian Martikov (see chapter 12, "The Wizard of Wines"). The old wereraven, realizing that he has a chance to end Strahd's tyranny, leaves his vineyard and winery in the capable hands of his sons, Adrian and Elvir. But before he travels to Castle Ravenloft to face Strahd, Davian insists on reconciling with his third son, Urwin Martikov (see chapter 5, area N2).`,
	[
		"This card refers to Victor Vallakovich (see chapter 5, area N3t). Realizing that the characters are the key to his salvation, he enthusiastically leaves home and accompanies them to Castle Ravenloft.",
		"This card refers to Lady Fiona Wachter (see chapter 5, area N4). If she is Strahd's enemy, she accompanies the characters to Castle Ravenloft, where she tries to convince them to help her take over Barovia after Strahd's defeat.",
		"This card refers to Stella Wachter (see chapter 5, area N4n). She grants the party no benefit unless her madness is cured. With her wits restored, Stella is happy to join the party and leave her rotten family behind.",
	],
	"This card refers to Ezmerelda d'Avenir (see appendix D). She can be found in the Abbey of Saint Markovia (see chapter 8, area S19), as well as several other locations throughout Barovia.",
	"There is no NPC who can inspire the characters.",
	[
		"This card refers to Pidlwick II (see chapter 4, area K59, as well as appendix D).",
		"This card refers to Clovin Belview (see chapter 8, area S17), the two-headed mongrelfolk. Clovin serves the Abbot out of fear and a perverse sense of loyalty. His job is to deliver food to the other mongrelfolk, whom he abhors. If the Abbot still lives, Clovin doesn't want to earn his Master's ire by attempting to leave, and he refuses to accompany the characters. But if the Abbot dies, Clovin doesn't have any reason to remain in the abbey, so he's willing to come along if he is bribed with wine. Clovin provides no benefit to the party without his viol.",
	],
	[
		"This card refers to the Mad Mage of Mount Baratok (see chapter 2, area M).",
		"This card refers to Donavich, the priest in the village of Barovia (see chapter 3, area E5). He will not accompany the characters until his son, Doru, is dead and buried.",
	],
	[
		"This card refers to Parriwimple (see chapter 3, area E1). Although he's a simpleton, he won't travel to Castle Ravenloft without good cause. Characters can manipulate him into going by preying on his good heart. For instance, he might go there to help rescue missing Barovians, or to save the life of Ireena Kolyana, who is very beautiful. The characters must somehow deal with Bildrath, Parriwimple's employer, who won't let the foolish boy go to the castle for any reason.",
		"This card refers to Ireena Kolyana (see chapter 3, area E4). Her brother, Ismark, opposes the idea of Ireena's being taken to Castle Ravenloft, but she insists on going there once the characters tell her about the card reading. Ireena won't accompany the characters, however, until Kolyan Indirovich's body is laid to rest in the cemetery.",
	],
	"This card refers to the werewolf Zuleika Toranescu (see chapter 15, area Z7). She will accompany the characters if they promise to avenge her mate, Emil, by killing the leader of her pack, Kiril Stoyanovich.",
	[
		`This card refers to Nikolai Wachter the elder, who is dead (see chapter 5, area N4o). If the characters cast a raise dead spell or a resurrection spell on his preserved corpse, Nikolai (LN male human noble) agrees to help the characters once he feels well enough, despite his wife's protests. Although his family has long supported Strahd, Nikolai came to realize toward the end of his life that Strahd must be destroyed to save Barovia. If the characters don't have the means to raise Nikolai from the dead, Rictavio (see appendix D) gives them a spell scroll of raise dead if he learns of their need. If they're staying at the Blue Water Inn, he leaves the scroll in one of their rooms.`,
		"This card refers to the Vistani assassin Arrigal (see chapter 5, area N9c). If the characters mention this card reading to him, he accepts his fate and accompanies them. If the characters succeed in defeating Strahd, Arrigal betrays and attacks them, believing that he is destined to become Barovia's new lord.",
	],
	`This card refers to Rictavio (see appendix D), who can be found at the Blue Water Inn in Vallaki (chapter 5, area N2). Normally reluctant to accompany the characters, Rictavio changes his tune if the characters tell him about the card reading. He sheds his disguise and introduces himself as Dr. Rudolph van Richten. The characters might think that Gadof Blinsky, the toymaker of Vallaki (area N7), is the figure they seek, because he has a pet monkey. If they speak to him about this possibility, Blinsky jokes that he and the monkey are "old friends," but if the characters ask him to come with them to fight Strahd, he politely declines. If the characters tell him about the tarokka reading, Blinsky admits that he acquired the monkey from a half-elf carnival ringmaster named Rictavio.`,
	"This card refers to Ismark Kolyanovich (see chapter 3, area E2). Ismark won't accompany the characters to Castle Ravenloft until he knows that his sister, Ireena Kolyana, is safe.",
];

strahd_location = [
	"Look to the father's tomb.",
	"I see a secret place—a vault of temptation hidden behind a woman of great beauty. The evil waits atop his tower of treasure.",
	"He waits for you in a place of wisdom, warmth, and despair. Great secrets are there.",
	"Look to the mother's tomb.",
	"He lurks in a hall of bones, in the dark pits of his castle.",
	"The cards can't see where the evil lurks. The mists obscure all!",
	"He lurks in the depths of darkness, in the one place to which he must return.",
	"Look to great heights. Find the beating heart of the castle. He waits nearby.",
	"He haunts the tomb of the man he envied above all.",
	"He dwells with the one whose blood sealed his doom, a brother of light snuffed out too soon.",
	"The beast sits on his dark throne.",
	"He lurks in the one place to which he must return—a place of death.",
	"He lurks in the darkness where the morning light once shone—a sacred place.",
	"I see a dark figure on a balcony, looking down upon this tortured land with a twisted smile.",
];

strahd_location_info = [
	"Strahd faces the characters in the tomb of King Barov and Queen Ravenovia (area K88).",
	`Strahd confronts the characters in the treasury (area K41). "A woman of great beauty" refers to the portrait of Tatyana hanging in the castle's study (area K37), which contains a secret door that leads to the treasury.`,
	"Strahd faces the characters in the study (area K37).",
	"Strahd faces the characters in the tomb of King Barov and Queen Ravenovia (area K88).",
	"Strahd faces the characters in the hall of bones (area K67).",
	"The card offers no clue about where the final showdown with Strahd will occur. It can happen anywhere you like in Castle Ravenloft. Alternatively, Madam Eva tells the characters to return to her after at least three days, and she will consult the cards again for them, but only to discern the location of their enemy.",
	"Strahd faces the characters in his tomb (area K86).",
	"Strahd faces the characters in the north tower peak (area K60).",
	"Strahd faces the characters in Sergei's tomb (area K85).",
	"Strahd faces the characters in Sergei's tomb (area K85).",
	"Strahd faces the characters in the audience hall (area K25).",
	"Strahd faces the characters in his tomb (area K86).",
	"Strahd faces the characters in the chapel (area K15).",
	"Strahd faces the characters at the overlook (area K6).",
];

let card_number = 0;

function drawUnique(array, count, exclude = []) {
	const filtered = array.filter((card) => !exclude.includes(card));
	const drawn = [];

	while (drawn.length < count) {
		const rand = filtered[Math.floor(Math.random() * filtered.length)];
		if (!drawn.includes(rand)) {
			drawn.push(rand);
		}
	}

	return drawn;
}

function drawCards() {
	// Draw 2 high cards
	const highDraw = drawUnique(high_cards, 2);

	// Draw 3 common cards, excluding already drawn high ones
	const commonDraw = drawUnique(common_cards, 3, highDraw);

	// Assign images
	document.getElementById("first_common").src = `assets/common_deck/${commonDraw[0]}.png`;
	if (commonDraw[0].length > 5) {
		// console.log(commonDraw[0].slice(-2));
		document.getElementById("see_1").innerHTML = common_explanations[Number(commonDraw[0].slice(-2)) - 1];
	} else {
		// console.log(commonDraw[0].slice(-1));
		document.getElementById("see_1").innerHTML = common_explanations[Number(commonDraw[0].slice(-1)) - 1];
	}

	document.getElementById("second_common").src = `assets/common_deck/${commonDraw[1]}.png`;
	if (commonDraw[1].length > 5) {
		// console.log(commonDraw[1].slice(-2));
		document.getElementById("see_2").innerHTML = common_explanations[Number(commonDraw[1].slice(-2)) - 1];
	} else {
		// console.log(commonDraw[1].slice(-1));
		document.getElementById("see_2").innerHTML = common_explanations[Number(commonDraw[1].slice(-1)) - 1];
	}

	document.getElementById("third_common").src = `assets/common_deck/${commonDraw[2]}.png`;
	if (commonDraw[2].length > 5) {
		// console.log(commonDraw[2].slice(-2));
		document.getElementById("see_3").innerHTML = common_explanations[Number(commonDraw[2].slice(-2)) - 1];
	} else {
		// console.log(commonDraw[2].slice(-1));
		document.getElementById("see_3").innerHTML = common_explanations[Number(commonDraw[2].slice(-1)) - 1];
	}

	// High Card 1 - Stahd's Enemy
	document.getElementById("first_high").src = `assets/high_deck/${highDraw[0]}.png`;
	if (highDraw[0].length > 5) {
		// console.log(highDraw[0].slice(-2));
		const index = Number(highDraw[0].slice(-2)) - 1;
		const enemy = strahd_enemy[index];
		if (Array.isArray(enemy)) {
			card_4_info_index = Math.floor(Math.random() * enemy.length);
			localStorage.setItem("card_4_info_index", JSON.stringify(card_4_info_index));
			document.getElementById("see_4").innerHTML = enemy[card_4_info_index];
		} else {
			document.getElementById("see_4").innerHTML = enemy;
		}
	} else {
		// console.log(highDraw[0].slice(-1));
		const index = Number(highDraw[0].slice(-1)) - 1;
		const enemy = strahd_enemy[index];
		if (Array.isArray(enemy)) {
			card_4_info_index = Math.floor(Math.random() * enemy.length);
			localStorage.setItem("card_4_info_index", JSON.stringify(card_4_info_index));
			document.getElementById("see_4").innerHTML = enemy[card_4_info_index];
		} else {
			document.getElementById("see_4").innerHTML = enemy;
		}
	}

	document.getElementById("second_high").src = `assets/high_deck/${highDraw[1]}.png`;
	if (highDraw[1].length > 5) {
		// console.log(highDraw[1].slice(-2));
		document.getElementById("see_5").innerHTML = strahd_location[Number(highDraw[1].slice(-2)) - 1];
	} else {
		// console.log(highDraw[1].slice(-1));
		document.getElementById("see_5").innerHTML = strahd_location[Number(highDraw[1].slice(-1)) - 1];
	}

	// Optional: Print results
	// console.log("High Cards:", highDraw.join(", "));
	//console.log("Common Cards:", commonDraw.join(", "));
}

function warningSave(firstCommon, defaultImage) {
	if (firstCommon === defaultImage) {
		// To show the warning
		document.getElementById("saveWarning").classList.remove("hidden");
		document.getElementById("saveWarning").classList.add("flex");
		return true; // blocked
	}
	return false; // not blocked
}

function warningSaveTurnOff() {
	document.getElementById("saveWarning").classList.add("hidden");
	document.getElementById("saveWarning").classList.remove("flex");
}

function saveSuccessTurnOff() {
	document.getElementById("saveSuccess").classList.add("hidden");
	document.getElementById("saveSuccess").classList.remove("flex");
}

function saveResults() {
	const defaultImage = "assets/card_back.png";

	// Extract relative path from the full URL
	let getRelativePath = (url) => url.substring(url.indexOf("assets/"));

	const firstCommon = getRelativePath(document.getElementById("first_common").src);
	const secondCommon = getRelativePath(document.getElementById("second_common").src);
	const thirdCommon = getRelativePath(document.getElementById("third_common").src);
	const firstHigh = getRelativePath(document.getElementById("first_high").src);
	const secondHigh = getRelativePath(document.getElementById("second_high").src);

	if (warningSave(firstCommon, defaultImage)) return;
	console.log("hi");

	const saved_results = {
		firstCommon: getRelativePath(firstCommon),
		secondCommon: getRelativePath(secondCommon),
		thirdCommon: getRelativePath(thirdCommon),
		firstHigh: getRelativePath(firstHigh),
		secondHigh: getRelativePath(secondHigh),
	};
	localStorage.setItem("saved_results", JSON.stringify(saved_results));

	const getRelativeCard = (url) => {
		const match = url.match(/(card\d+)\.png$/);
		return match ? match[1] : null;
	};

	console.log(getRelativeCard(firstHigh));
	let highCard1Index;
	if (getRelativeCard(firstHigh).length > 5) {
		highCard1Index = parseInt(getRelativeCard(firstHigh).slice(-2), 10) - 1;
	} else {
		highCard1Index = parseInt(getRelativeCard(firstHigh).slice(-1), 10) - 1;
	}
	let info_card_4 = strahd_enemy_info[highCard1Index];
	console.log(info_card_4);
	if (Array.isArray(info_card_4)) {
		info_card_4 = info_card_4[localStorage.getItem("card_4_info_index")];
		console.log(info_card_4);
	}
	localStorage.setItem("info_card_4", JSON.stringify(info_card_4));
	console.log("Saved Card 4 Info:", localStorage.getItem("info_card_4"));

	document.getElementById("saveSuccess").classList.remove("hidden");
	document.getElementById("saveSuccess").classList.add("flex");
}

function loadResults(savedCard, cardIndex) {
	document.getElementById("ai-response").innerHTML = "Loading...";

	let item_ally_location;
	let card_name = common_card_name[cardIndex];

	const item_card = document.getElementById("item-card");
	if (card_number === 0) {
		item_card.innerHTML = "Tome of Strahd - " + common_card_name[cardIndex];
		item_ally_location = "Tome of Strahd";
	} else if (card_number === 1) {
		item_card.innerHTML = "Holy Symbol of Ravenkind - " + common_card_name[cardIndex];
		item_ally_location = "Holy Symbol of Ravenkind";
	} else if (card_number === 2) {
		item_card.innerHTML = "Sun Sword - " + common_card_name[cardIndex];
		item_ally_location = "Sun Sword";
	} else if (card_number === 3) {
		item_card.innerHTML = "Strahd's Enemy - " + high_card_name[cardIndex];
		item_ally_location = "Strahd's Enemy";
	} else if (card_number === 4) {
		item_card.innerHTML = "Strahd - " + high_card_name[cardIndex];
		item_ally_location = "Strahd's Location";
	}

	const tarokka_card = document.getElementById("tarokka-card");
	tarokka_card.src = savedCard;

	console.log("Card Index:" + cardIndex);
	if (card_number !== 3 && card_number !== 4) {
		const cardInfo = document.getElementById("card-info");
		cardInfo.innerHTML = `<strong>${common_card_info[cardIndex]}</strong>`;
		card_clue = cardInfo.innerHTML;
		// card_name = common_card_name[cardIndex];
	} else {
		card_name = high_card_name[cardIndex];
		if (card_number === 3) {
			info = localStorage.getItem("info_card_4");
			card_clue = localStorage.getItem("info_card_4");
		} else {
			if (card_number === 4) {
				info = strahd_location_info[cardIndex];
			}
		}
		const cardInfo = document.getElementById("card-info");
		cardInfo.innerHTML = `<strong>${info}</strong>`;
		card_clue = cardInfo.innerHTML;
	}
	card_name = common_card_name[cardIndex];
	let question = `You're a helpful plot-writing assistant for tabletop RPGs. Give the best advice to a Dungeon Master writing or adapting a compelling plot for the Curse of Strahd campaign. Specifically, the "${card_name}" card has been drawn to locate the ${item_ally_location}. The clue is: "${card_clue}". Provide creative advice for how to incorporate this into story pacing, tone, and narrative buildup. Keep the advice under 100 words.`;
	console.log("Question for Gemini:", question);

	// askGemini(question).then((answer) => {
	// 	document.getElementById("ai-response").innerHTML = answer;
	// });
}

function runCard(cardNumber) {
	if (card_number === 0) {
		document.getElementById("previous-button").classList.add("opacity-0", "pointer-events-none");
	} else {
		document.getElementById("previous-button").classList.remove("opacity-0", "pointer-events-none");
	}
	if (card_number === 4) {
		document.getElementById("next-button").classList.remove("opacity-0", "pointer-events-none");
		document.getElementById("next-button").classList.add("opacity-0", "pointer-events-none");
	} else {
		document.getElementById("next-button").classList.remove("opacity-0", "pointer-events-none");
	}
	const savedStr = localStorage.getItem("saved_results");
	// console.log(savedStr);

	// Parse it into an object if it exists
	let saved = savedStr ? JSON.parse(savedStr) : null;
	saved = Object.values(saved);

	const getRelativePath = (url) => {
		const match = url.match(/card\d+\.png$/);
		return match ? match[0] : null;
	};

	const getRelativeCard = (url) => {
		const match = url.match(/(card\d+)\.png$/);
		return match ? match[1] : null;
	};

	let cardIndex;
	if (getRelativeCard(saved[cardNumber]).length > 5) {
		cardIndex = parseInt(getRelativeCard(saved[cardNumber]).slice(-2), 10) - 1;
	} else {
		cardIndex = parseInt(getRelativeCard(saved[cardNumber]).slice(-1), 10) - 1;
	}
	console.log("Saved Card Number:", saved[cardNumber]);
	loadResults(saved[card_number], cardIndex);
}

function nextCard() {
	card_number++;
	console.log("Card Number:", card_number);
	runCard(card_number);
}

function previousCard() {
	card_number--;
	console.log("Card Number:", card_number);
	runCard(card_number);
}

function viewDMResults() {
	const savedRaw = localStorage.getItem("saved_results");
	// if (!savedRaw) return alert("You have not saved any results yet. Please save your tarot reading first.");
	console.log(savedRaw);
	console.log("hi");
	if (savedRaw === null) {
		document.getElementById("dmResultsWarningEmpty").classList.remove("hidden");
		document.getElementById("dmResultsWarningEmpty").classList.add("flex");
	} else {
		document.getElementById("dmResultsWarningSpoiler").classList.remove("hidden");
		document.getElementById("dmResultsWarningSpoiler").classList.add("flex");
	}

	// if (confirm("This will reveal spoilers for the players in Curse of Strahd. Are you sure you want to continue?")) {
	// 	window.location.replace("dm_results.html");
	// }
}

function dmResultWarningEmpty() {
	document.getElementById("dmResultsWarningEmpty").classList.add("hidden");
	document.getElementById("dmResultsWarningEmpty").classList.remove("flex");
}

function dmResultGoBack() {
	document.getElementById("dmResultsWarningSpoiler").classList.add("hidden");
	document.getElementById("dmResultsWarningSpoiler").classList.remove("flex");
}

function dmResultContinue() {
	document.getElementById("dmResultsWarningSpoiler").classList.add("hidden");
	document.getElementById("dmResultsWarningSpoiler").classList.remove("flex");

	window.location.replace("dm_results.html");
}

async function askGemini(question) {
	const API_KEY = "api_key_here"; // Replace with your actual API key
	const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;

	try {
		const res = await fetch(url, {
			method: "POST",
			headers: { "Content-Type": "application/json" },
			body: JSON.stringify({
				contents: [{ parts: [{ text: question }] }],
			}),
		});

		const data = await res.json();
		console.log(data);
		const answer = data.candidates?.[0]?.content?.parts?.[0]?.text;
		console.log(answer);
		return answer || "No answer found.";
	} catch (err) {
		console.error("Gemini API error:", err);
		return "Error reaching Gemini.";
	}
}

const fateButton = document.getElementById("fateButton");
if (fateButton) {
	fateButton.addEventListener("click", drawCards);
}

if (window.location.pathname.endsWith("dm_results.html")) {
	console.log(localStorage.getItem("saved_results"));
	runCard(card_number); // CHANGE A NAME
}

// localStorage.clear();
